<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電影搜尋系統</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="search-container">
            <form id="searchForm" onsubmit="handleSearch(event)">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="請輸入電影分類..." required>
                    <button type="submit" class="search-button">搜尋</button>
                </div>
            </form>
        </div>
        <div class="loading" id="loading" style="display: none;">搜尋中...</div>
		
		<div id="results" class="results-container">
		    <!-- 結果會在這裡動態填入 -->
		</div>
    </div>

    <script>
        async function handleSearch(event) {
            event.preventDefault();
            const searchInput = document.getElementById('searchInput');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            loading.style.display = 'block';
            results.innerHTML = '';

            try {
                const response = await fetch(`/api/search?keyword=${encodeURIComponent(searchInput.value)}`);
                const movieNames = await response.json();

                if (Object.keys(movieNames).length > 0) {
					displayResults(movieNames)
                } else {
					results.innerHTML = '<div class="result-item">未找到相關電影</div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="result-item">發生錯誤：${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

		async function fetchMovieSummary(movieName) {
		    try {
		        const response = await fetch(`/api/movies/summary?movieName=${encodeURIComponent(movieName)}`);
		        if (!response.ok) throw new Error("無法取得簡介");
		        return await response.text();
		    } catch (error) {
		        console.error("Error fetching summary:", error);
		        return "發生錯誤，無法獲取簡介";
		    }
		}
		
		function displayResults(movieScores) {
		    const results = document.getElementById('results');
		    if (Object.keys(movieScores).length === 0) {
		        results.innerHTML = '<div class="error">找不到相關電影</div>';
		        return;
		    }
		    results.innerHTML = Object.entries(movieScores)
		        .map(([score, movieName]) => `
		            <div class="movie-item">
		                <div class="movie-header">
							<span class="movie-score">分數: ${score}</span> <br>
		                    <span class="movie-title">${movieName}</span>
		                </div>
		                <button class="show-summary" onclick="toggleSummary('${movieName}')">劇情簡介</button> 
		                <div class="movie-summary" id="summary-${movieName}"></div>
		            </div>
		        `)
		        .join('');
		}


		async function toggleSummary(movieName) {
		    const summaryContainer = document.getElementById(`summary-${movieName}`);
		    if (summaryContainer.style.display === "none") {
		        const summary = await fetchMovieSummary(movieName);
		        summaryContainer.innerHTML = `<p>${summary}</p>`;
		        summaryContainer.style.display = "block";
		    } else {
		        summaryContainer.style.display = "none";
		    }
		}

		
    </script>
</body>

</html>
