<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電影搜尋系統</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="search-container">
            <form id="searchForm" onsubmit="handleSearch(event)">
                <div class="search-box">
					
                    <input type="text" id="searchInput" value="愛情" class="search-input" placeholder="請輸入電影分類..." required>
                    <button type="submit" class="search-button">搜尋</button>
					
                </div>
				<div id="result-count" class="result-count"></div>
            </form>
        </div>
        <div class="loading" id="loading" style="display: none;">搜尋中...</div>
		
		<div id="results" class="results-container"></div>
		<div id="pagination" class="pagination-container"></div>
		
    </div>

    <script>
		async function handleSearch(event, currentPage = 1) {
		    if (event) event.preventDefault();
		    const searchInput = document.getElementById('searchInput');
		    const loading = document.getElementById('loading');
		    const results = document.getElementById('results');
		    const pagination = document.getElementById('pagination');

		    loading.style.display = 'block';
		    results.innerHTML = '';
		    pagination.innerHTML = '';

		    try {
		        const response = await fetch(`/api/movies/search?keyword=${encodeURIComponent(searchInput.value)}`);
		        const { scores, relatedSearches } = await response.json();

		        if (Object.keys(scores).length > 0) {
		            displayResults(scores, currentPage);
		        } else {
		            results.innerHTML = '<div class="result-item">未找到相關電影</div>';
		        }

		        if (relatedSearches && relatedSearches.length > 0) {
		            const relatedSection = `
		                <div class="related-searches">
							
		                    <h3>其他人也搜尋了：</h3>
		                    <ul>${relatedSearches.map(search => `<li>${search}</li>`).join('')}</ul>
		                </div>
		            `;
		            results.innerHTML += relatedSection;
		        }
		    } catch (error) {
		        results.innerHTML = `<div class="result-item">發生錯誤：${error.message}</div>`;
		    } finally {
		        loading.style.display = 'none';
		    }
		}


		async function fetchMovieSummary(movieName) {
		    try {
		        const response = await fetch(`/api/movies/summary?movieName=${encodeURIComponent(movieName)}`);
		        if (!response.ok) throw new Error("無法取得簡介");
		        return await response.text();
		    } catch (error) {
		        console.error("Error fetching summary:", error);
		        return "發生錯誤，無法獲取簡介";
		    }
		}
		
		function displayResults(movieScores, currentPage = 1, pageSize = 20) {
		    const results = document.getElementById('results');
		    const pagination = document.getElementById('pagination');
		    const resultCount = document.getElementById('result-count');
		    
		    // 將對象轉換為數組然後按分數排序
		    const sortedMovies = Object.entries(movieScores)
		        .sort(([, a], [, b]) => b - a)
		        .slice((currentPage - 1) * pageSize, currentPage * pageSize);

		    resultCount.innerHTML = `搜尋結果共 ${Object.keys(movieScores).length} 部電影`;

		    results.innerHTML = sortedMovies
		        .map(([movieName, score]) => `
		            <div class="movie-item">
		                <div class="movie-content">
		                    <div class="movie-title">${movieName}</div>
		                    <div class="movie-actions">
		                        <span class="movie-score">分數: ${score}</span>
		                        <button class="show-summary" onclick="toggleSummary('${movieName}')">劇情簡介</button>
		                    </div>
		                </div>
		                <div class="movie-summary" id="summary-${movieName}" style="display: none;"></div>
		            </div>
		        `)
		        .join('');
			
		    pagination.innerHTML = `
		        <button class="pagination-button" 
		                onclick="changePage(${currentPage - 1})" 
		                style="visibility: ${currentPage > 1 ? 'visible' : 'hidden'};">
		            上一頁
		        </button>
		        ${currentPage === Math.ceil(Object.keys(movieScores).length / pageSize) ? 
		            '<div class="pagination-info">本頁為最後一頁</div>' : ''}
		        <button class="pagination-button" 
		                onclick="changePage(${currentPage + 1})" 
		                style="visibility: ${currentPage < Math.ceil(Object.keys(movieScores).length / pageSize) ? 'visible' : 'hidden'};">
		            下一頁
		        </button>
		    `;
		}

		function changePage(page) {
		    handleSearch(null, page);
		}


		async function toggleSummary(movieName) {
		    const summaryContainer = document.getElementById(`summary-${movieName}`);
		    if (summaryContainer.style.display === "none") {
		        const summary = await fetchMovieSummary(movieName);
		        summaryContainer.innerHTML = `<p>${summary}</p>`;
		        summaryContainer.style.display = "block";
		    } else {
		        summaryContainer.style.display = "none";
		    }
		}

		
    </script>
</body>

</html>
