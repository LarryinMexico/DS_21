<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電影搜尋系統</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
	<div class="search-wrapper" id="searchWrapper">
	    <div class="container">
	        <div class="search-container">
	            <form id="searchForm" onsubmit="handleSearch(event)">
	                <div class="search-box">
	                    <input type="text" id="searchInput" class="search-input" placeholder="請輸入電影分類..." required>
	                    <button type="submit" class="search-button">搜尋</button>
	                </div>
	                <div id="result-count" class="result-count"></div>
	            </form>
	        </div>
	    </div>
	</div>

	<!-- 搜尋結果 -->
	<div class="results-section" id="resultsSection">
	    <div class="loading" id="loading" style="display: none;">搜尋中...</div>
	    <div id="results" class="results-container"></div>
	    <div id="pagination" class="pagination-container"></div>
	    <div id="related-searches-container"></div>
	</div>

    <script>
		let isFirstSearch = true;
		
		// 定義全局變量
		let globalSearchResults = {
		    scores: null,
		    isMovieCategory: false,
		    relatedSearches: [],
		    currentPage: 1,
		    pageSize: 20
		};

		async function handleSearch(event) {
		    if (event) event.preventDefault();
		    
		    // 重置分頁
		    globalSearchResults.currentPage = 1;
		    
		    if (isFirstSearch) {
		        document.getElementById('searchWrapper').classList.add('moved');
		        const resultsSection = document.getElementById('resultsSection');
		        resultsSection.style.display = 'block';
		        setTimeout(() => {
		            resultsSection.classList.add('active');
		        }, 50);
		        isFirstSearch = false;
		    }

		    const searchInput = document.getElementById('searchInput');
		    const loading = document.getElementById('loading');
		    const results = document.getElementById('results');
		    const pagination = document.getElementById('pagination');
		    const relatedSearchesContainer = document.getElementById('related-searches-container');

		    loading.style.display = 'block';
		    results.innerHTML = '';
		    pagination.innerHTML = '';
		    relatedSearchesContainer.innerHTML = '';

		    try {
		        const response = await fetch(`/api/movies/search?keyword=${encodeURIComponent(searchInput.value)}`);
		        const data = await response.json();

		        // 存儲搜索結果到全局變量
		        globalSearchResults = {
		            ...globalSearchResults,
		            scores: data.scores,
		            isMovieCategory: data.isMovieCategory,
		            relatedSearches: data.relatedSearches || []
		        };

		        if (data.isMovieCategory) {
		            if (Object.keys(data.scores).length > 0) {
		                displayMovieResults(data.scores);
		            } else {
		                results.innerHTML = '<div class="result-item">未找到相關電影</div>';
		            }
		        } else {
		            displayGeneralResults(data.generalResults);
		        }

		        if (data.relatedSearches && data.relatedSearches.length > 0) {
		            displayRelatedSearches(data.relatedSearches);
		        }
		    } catch (error) {
		        results.innerHTML = `<div class="result-item">發生錯誤：${error.message}</div>`;
		    } finally {
		        loading.style.display = 'none';
		    }
		}

		async function fetchMovieSummary(movieName) {
		    try {
		        const response = await fetch(`/api/movies/summary?movieName=${encodeURIComponent(movieName)}`);
		        if (!response.ok) throw new Error("無法取得簡介");
		        return await response.text();
		    } catch (error) {
		        console.error("Error fetching summary:", error);
		        return "發生錯誤，無法獲取簡介";
		    }
		}
		
		function displayGeneralResults(searchResults) {
		    const results = document.getElementById('results');
		    const resultCount = document.getElementById('result-count');
		    
		    resultCount.innerHTML = `搜尋結果共 ${searchResults.length} 項結果`;
		    
		    const resultsHTML = searchResults.map(result => `
		        <div class="result-item">
		            <div class="result-content">
		                <a href="${result.url}" target="_blank" class="result-title">
		                    ${result.title}
		                </a>
		                <div class="result-url">${result.url}</div>
		            </div>
		        </div>
		    `).join('');
		    
		    results.innerHTML = resultsHTML;
		}
		
		function displayMovieResults(movieScores) {
		    const results = document.getElementById('results');
		    const pagination = document.getElementById('pagination');
		    const resultCount = document.getElementById('result-count');
		    
		    const totalMovies = Object.entries(movieScores).length;
		    const totalPages = Math.ceil(totalMovies / globalSearchResults.pageSize);
		    const startIndex = (globalSearchResults.currentPage - 1) * globalSearchResults.pageSize;
		    const endIndex = startIndex + globalSearchResults.pageSize;
		    
		    // 對電影進行排序並獲取當前頁的數據
		    const sortedMovies = Object.entries(movieScores)
		        .sort(([, a], [, b]) => b - a)
		        .slice(startIndex, endIndex);

		    resultCount.innerHTML = `搜尋結果共 ${totalMovies} 部電影（第 ${globalSearchResults.currentPage} 頁，共 ${totalPages} 頁）`;

		    // 生成電影列表html
		    const moviesHTML = sortedMovies
		        .map(([movieName, score]) => {
		            const stars = '★'.repeat(score) + '☆'.repeat(5 - score);
		            return `
		                <div class="movie-item">
		                    <div class="movie-content">
		                        <div class="movie-title">${movieName}</div>
		                        <div class="movie-actions">
		                            <span class="movie-score">分數: ${score} <span class="stars">${stars}</span></span>
		                            <button class="show-summary" onclick="toggleSummary('${movieName}')">劇情簡介</button>
		                        </div>
		                    </div>
		                    <div class="movie-summary" id="summary-${movieName}" style="display: none;"></div>
		                </div>
		            `;
		        })
		        .join('');

		    results.innerHTML = moviesHTML;

		    // 更新分頁按鈕
		    updatePagination(totalPages);
		}
		
		function updatePagination(totalPages) {
		    const pagination = document.getElementById('pagination');
		    const { currentPage } = globalSearchResults;

		    pagination.innerHTML = `
		        <button class="pagination-button" 
		                onclick="changePage(${currentPage - 1})"
		                ${currentPage <= 1 ? 'disabled' : ''}>
		            上一頁
		        </button>
		        <span class="pagination-info">
		            第 ${currentPage} 頁 / 共 ${totalPages} 頁
		        </span>
		        <button class="pagination-button" 
		                onclick="changePage(${currentPage + 1})"
		                ${currentPage >= totalPages ? 'disabled' : ''}>
		            下一頁
		        </button>
		    `;
		}

		function changePage(newPage) {
		    const totalPages = Math.ceil(Object.entries(globalSearchResults.scores).length / globalSearchResults.pageSize);
		    
		    // 驗證頁碼是否有效
		    if (newPage < 1 || newPage > totalPages) {
		        return;
		    }

		    // 更新當前頁碼
		    globalSearchResults.currentPage = newPage;
		    
		    // 使用現有的數據重新顯示結果
		    displayMovieResults(globalSearchResults.scores);
		}
		
		function displayRelatedSearches(relatedSearches) {
		    const container = document.getElementById('related-searches-container');
		    container.innerHTML = `
		        <div class="related-searches-box">
		            <h3>其他人也搜尋了：</h3>
		            <div class="related-items">
		                ${relatedSearches.map(search => `
		                    <div class="related-item" onclick="document.getElementById('searchInput').value='${search}'; handleSearch(null, 1)">
		                        ${search}
		                    </div>
		                `).join('')}
		            </div>
		        </div>
		    `;
		}

		async function toggleSummary(movieName) {
		    const summaryContainer = document.getElementById(`summary-${movieName}`);
		    if (summaryContainer.style.display === "none") {
		        const summary = await fetchMovieSummary(movieName);
		        summaryContainer.innerHTML = `<p>${summary}</p>`;
		        summaryContainer.style.display = "block";
		    } else {
		        summaryContainer.style.display = "none";
		    }
		}

		
    </script>
</body>

</html>
